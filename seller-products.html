<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Your Products ‚Äî BlueBite</title>

    <link rel="stylesheet" href="css/style.css" />

    <style>
        .page-wrapper {
            max-width: 1050px;
            margin: auto;
            padding: 20px;
        }

        .product-list {
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 15px;
        }

        .product-card {
            background: white;
            padding: 15px;
            border-radius: 16px;
            box-shadow: var(--shadow);
        }

        .product-card img {
            width: 100%;
            height: 160px;
            border-radius: 12px;
            object-fit: cover;
            background: #f3f4f6;
        }

        .product-title {
            font-size: 16px;
            font-weight: 700;
            margin-top: 8px;
        }

        .product-price {
            color: #1657d6;
            font-weight: 600;
            margin: 4px 0;
        }

        .prod-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }

        .btn-small {
            width: 100%;
            padding: 7px 0;
            border-radius: 8px;
            font-size: 13px;
        }

        /* MODAL */
        .modal-bg {
            position: fixed;
            inset: 0;
            display: none;
            justify-content: center;
            align-items: center;
            background: rgba(0,0,0,0.45);
            backdrop-filter: blur(3px);
            z-index: 9999;
        }

        .modal {
            width: 92%;
            max-width: 430px;
            background: white;
            padding: 20px;
            border-radius: 18px;
            box-shadow: 0 8px 18px rgba(0,0,0,0.2);
        }

        .modal input,
        .modal textarea {
            width: 100%;
            padding: 10px;
            border-radius: 12px;
            border: 1px solid #d1d5db;
            margin-top: 8px;
        }

        .image-preview-box {
            width: 100%;
            height: 180px;
            margin-top: 10px;
            border-radius: 12px;
            background: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            font-size: 26px;
        }

        .image-preview-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: #2767ff;
            color: white;
            padding: 10px 18px;
            border-radius: 12px;
            opacity: 0;
            pointer-events: none;
            transition: 0.3s;
            z-index: 9999;
            font-size: 13px;
        }
        .toast.show {
            opacity: 1;
            pointer-events: all;
        }
    </style>
</head>

<body>

    <!-- NAVBAR -->
    <div class="navbar">
        <h1>BlueBite</h1>
        <div>
            <a href="seller-dashboard.html">Dashboard</a>
            <a href="seller-add-product.html">Add Product</a>
            <a href="seller-products.html">Products</a>
            <a href="seller-orders.html">Orders</a>
            <a href="#" onclick="Auth.logout()">Logout</a>
        </div>
    </div>

    <div class="page-wrapper">
        <h2 style="color:#1657d6;">Your Products üì¶</h2>
        <p class="subtext">Manage, edit and delete your menu items.</p>

        <div id="productList" class="product-list">Loading...</div>
    </div>

    <!-- EDIT PRODUCT MODAL -->
    <div id="editModal" class="modal-bg">
        <div class="modal">
            <h3>Edit Product</h3>

            <label>Name</label>
            <input id="editName">

            <label>Price</label>
            <input id="editPrice" type="number">

            <label>Description</label>
            <textarea id="editDesc"></textarea>

            <label>Image</label>
            <input id="editImageFile" type="file" accept="image/*">

            <div class="image-preview-box" id="editImagePreview">üì∑</div>

            <button id="saveEditBtn" style="width:100%; margin-top:12px;">Save</button>
            <button onclick="closeModal()" style="width:100%; margin-top:8px; background:#e5e7eb;">
                Cancel
            </button>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="toast"></div>

    <script type="module">
        import { supabase } from "./js/supabase.js";
        import { requireAuth } from "./js/auth.js";
        import { getSellerStore } from "./js/seller.js";
        import * as Auth from "./js/auth.js";

        window.Auth = Auth;

        let currentStore = null;
        let currentEditId = null;

        const productList = document.getElementById("productList");
        const editModal = document.getElementById("editModal");
        const editName = document.getElementById("editName");
        const editPrice = document.getElementById("editPrice");
        const editDesc = document.getElementById("editDesc");
        const editImageFile = document.getElementById("editImageFile");
        const editImagePreview = document.getElementById("editImagePreview");
        const saveEditBtn = document.getElementById("saveEditBtn");

        function showToast(msg, color = "#2767ff") {
            const t = document.getElementById("toast");
            t.textContent = msg;
            t.style.background = color;
            t.classList.add("show");
            setTimeout(() => t.classList.remove("show"), 1500);
        }

        // ‚≠ê MUST BE GLOBAL ‚Äî FIX FOR DELETE NOT WORKING
        window.deleteProduct = async function(id) {
            console.log("DELETE CLICKED:", id);
            id = Number(id);

            if (!confirm("Delete this product?")) return;

            const { error } = await supabase
                .from("products")
                .delete()
                .eq("id", id);

            if (error) {
                console.error(error);
                showToast("Delete failed!", "#ef4444");
                return;
            }

            showToast("Product deleted ‚úîÔ∏è", "#22c55e");
            loadProducts();
        };

        // ‚≠ê GLOBAL EDIT FUNCTION
        window.editProduct = function(id, name, price, desc, img) {
            currentEditId = Number(id);

            editName.value = name;
            editPrice.value = price;
            editDesc.value = desc;

            if (img) {
                editImagePreview.innerHTML = `<img src="${img}">`;
            } else {
                editImagePreview.innerHTML = "üì∑";
            }

            editModal.style.display = "flex";
        };

        window.closeModal = function() {
            editModal.style.display = "none";
            editImageFile.value = "";
        };

        init();

        async function init() {
            await requireAuth("seller", "seller-login.html");
            currentStore = await getSellerStore();

            if (!currentStore) {
                showToast("Create your store first!", "#ef4444");
                return;
            }

            loadProducts();
        }

        async function loadProducts() {
            const { data } = await supabase
                .from("products")
                .select("*")
                .eq("store_id", currentStore.id)
                .order("id", { ascending: false });

            if (!data.length) {
                productList.innerHTML = "<p>No products yet.</p>";
                return;
            }

            productList.innerHTML = "";

            data.forEach(p => {
                const img = p.image_url || "https://via.placeholder.com/300x200?text=Food";

                productList.innerHTML += `
                    <div class="product-card">
                        <img src="${img}">
                        <div class="product-title">${p.name}</div>
                        <div class="product-price">‚Ç±${Number(p.price).toLocaleString()}</div>

                        <div class="prod-actions">
                            <button class="btn-small" style="background:#1657d6; color:white;"
                                onclick="editProduct('${p.id}', '${p.name}', '${p.price}', \`${p.description || ""}\`, '${p.image_url || ""}')">
                                Edit
                            </button>

                            <button class="btn-small" style="background:#dc2626; color:white;"
                                onclick="deleteProduct('${p.id}')">
                                Delete
                            </button>
                        </div>
                    </div>
                `;
            });
        }

        async function uploadImage(file) {
            if (!file) return null;

            const ext = file.name.split(".").pop();
            const filePath = `store-${currentStore.id}/${Date.now()}.${ext}`;

            await supabase.storage
                .from("product-images")
                .upload(filePath, file);

            const { data } = supabase.storage
                .from("product-images")
                .getPublicUrl(filePath);

            return data.publicUrl;
        }

        saveEditBtn.onclick = async () => {
            const name = editName.value.trim();
            const price = Number(editPrice.value.trim());
            const desc = editDesc.value.trim();
            const imgFile = editImageFile.files[0];

            if (!name || !price) {
                showToast("Name and price required!", "#ef4444");
                return;
            }

            let newImg = null;
            if (imgFile) newImg = await uploadImage(imgFile);

            const update = {
                name,
                price,
                description: desc
            };

            if (newImg) update.image_url = newImg;

            const { error } = await supabase
                .from("products")
                .update(update)
                .eq("id", currentEditId);

            if (error) {
                console.error(error);
                showToast("Update failed!", "#ef4444");
                return;
            }

            showToast("Product updated ‚úîÔ∏è", "#22c55e");
            closeModal();
            loadProducts();
        };
    </script>

</body>
</html>