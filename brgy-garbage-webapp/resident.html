<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Resident Dashboard ‚Äî GarboTrack</title>

<link rel="stylesheet" href="css/garbotrack.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<style>
  .dashboard-container {
    padding: 20px;
    display: grid;
    gap: 20px;
    grid-template-columns: 1fr;
  }
  @media (min-width: 900px) {
    .dashboard-container {
      grid-template-columns: 1fr 1fr;
    }
  }
  .card {
    background: #ffffff;
    border-radius: 16px;
    padding: 18px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    animation: fadeIn 0.4s ease;
  }
  #map {
    width: 100%;
    height: 420px;
    border-radius: 14px;
    margin-top: 10px;
  }
  .list-item {
    padding: 12px;
    background: #f4fff4;
    border-radius: 10px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    border: 1px solid #d4ecd4;
  }
  .list-item strong {
    font-size: 15px;
    color: #2e8b57;
  }
  .btn-action {
    padding: 6px 10px;
    border-radius: 8px;
    background: #2e8b57;
    color: white;
    border: none;
    cursor: pointer;
  }
  .btn-action:hover {
    background: #256945;
  }
  textarea {
    width: 100%;
    padding: 12px;
    height: 110px;
    resize: none;
    border-radius: 12px;
    border: 1px solid #d7e9df;
  }
  @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
</style>

</head>
<body>

<header class="topbar">
  <h2><i class="fa-solid fa-house"></i> Resident Dashboard</h2>
</header>

<main class="dashboard-container">

  <!-- SCHEDULES -->
  <section class="card" style="grid-column: span 2;">
    <div style="display:flex; justify-content: space-between; align-items:center;">
      <h3>Your Upcoming Pickups</h3>
      <button id="refreshSchedules" class="btn small">
        <i class="fa-solid fa-rotate"></i> Refresh
      </button>
    </div>
    <ul id="scheduleList"></ul>
  </section>

  <!-- MAP -->
  <section class="card" style="grid-column: span 2;">
    <h3><i class="fa-solid fa-map-location-dot"></i> Live Collector Location</h3>
    <div id="map"></div>
    <p class="muted">Icons: üöõ for collector, üè† for your home.</p>
  </section>

  <!-- REPORT -->
  <section class="card">
    <h3>Report Missed Pickup</h3>
    <textarea id="missedReport" placeholder="Describe what happened..."></textarea>
    <button id="reportBtn" class="btn primary" style="margin-top:10px; width:100%;">
      <i class="fa-solid fa-paper-plane"></i> Submit Report
    </button>
  </section>

</main>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module" src="js/main.js"></script>

<script>
(async function initResident() {

  await window.GARBO.init();

  /** --------------------------
   * MAP
   * ---------------------------*/
  const map = L.map('map').setView([14.5995, 120.9842], 13);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19
  }).addTo(map);

  // CDN Icons
  const truckIcon = L.icon({
    iconUrl: "https://cdn-icons-png.flaticon.com/512/743/743007.png",
    iconSize: [42, 42],
  });

  const homeIcon = L.icon({
    iconUrl: "https://cdn-icons-png.flaticon.com/512/1946/1946433.png",
    iconSize: [38, 38],
  });

  // Show resident location
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      L.marker([lat, lng], { icon: homeIcon }).addTo(map).bindPopup("Your Location");
      map.setView([lat, lng], 14);
    });
  }

  /** --------------------------
   * LOAD SCHEDULES
   * ---------------------------*/
  async function loadSchedules() {
    const { data } = await window.GARBO.supabase
      .from("schedules")
      .select("*")
      .order("date", { ascending: true });

    const list = document.getElementById("scheduleList");
    list.innerHTML = "";

    if (!data || data.length === 0) {
      list.innerHTML = "<p class='muted'>No scheduled pickups.</p>";
      return;
    }

    data.forEach(s => {
      const li = document.createElement("li");
      li.className = "list-item";

      li.innerHTML =
        `<div>
          <strong>${s.barangay}</strong>
          <div class="muted">${s.date} ‚Äî ${s.time}</div>
        </div>`;

      const btn = document.createElement("button");
      btn.className = "btn-action";
      btn.innerHTML = "Request ETA";

      btn.onclick = async () => {
        await window.GARBO.supabase
          .from("eta_requests")
          .insert([{ schedule_id: s.id, requested_by: "resident_test" }]);
        alert("ETA requested successfully!");
      };

      li.appendChild(btn);
      list.appendChild(li);
    });
  }

  document.getElementById("refreshSchedules").addEventListener("click", loadSchedules);
  loadSchedules();

  /** --------------------------
   * REPORT MISSED PICKUP
   * ---------------------------*/
  document.getElementById("reportBtn").addEventListener("click", async () => {
    const txt = document.getElementById("missedReport").value.trim();
    if (!txt) return alert("Please describe the issue.");

    await window.GARBO.supabase.from("reports").insert([
      { message: txt, type: "missed_pickup" }
    ]);

    document.getElementById("missedReport").value = "";
    alert("Report submitted!");
  });

  /** --------------------------
   * REALTIME LOCATION OF COLLECTOR
   * ---------------------------*/
  window.GARBO.supabase
    .channel("collector_positions")
    .on(
      "postgres_changes",
      { event: "UPDATE", schema: "public", table: "collectors_positions" },
      (payload) => {
        const p = payload.new;
        if (!window.collectorMarker) {
          window.collectorMarker = L.marker([p.lat, p.lng], { icon: truckIcon }).addTo(map);
        } else {
          window.collectorMarker.setLatLng([p.lat, p.lng]);
        }
      }
    )
    .subscribe();

})();
</script>

</body>
</html>
