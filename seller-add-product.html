<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Add Product ‚Äî BlueBite</title>
  <link rel="stylesheet" href="css/style.css" />

  <style>
    .page-wrapper {
      max-width: 800px;
      margin: auto;
      padding: 20px;
    }

    .form-card {
      background: #fff;
      padding: 20px;
      border-radius: 18px;
      box-shadow: var(--shadow);
    }

    .form-card h2 {
      margin-bottom: 5px;
      color: #1657d6;
    }

    .form-card p.subtext {
      margin-bottom: 18px;
      font-size: 13px;
      color: #6b7280;
    }

    .form-row {
      margin-bottom: 12px;
    }

    .form-row label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #374151;
    }

    .form-row input,
    .form-row textarea {
      width: 100%;
      padding: 9px 11px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      outline: none;
    }

    .form-row textarea {
      resize: vertical;
      min-height: 80px;
    }

    .form-row small {
      font-size: 11px;
      color: #6b7280;
    }

    .actions {
      margin-top: 16px;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #374151;
    }

    /* IMAGE PREVIEW */
    .image-preview-wrap {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 10px;
    }

    .image-preview-box {
      width: 90px;
      height: 90px;
      border-radius: 12px;
      border: 1px dashed #d1d5db;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      background: #f9fafb;
      font-size: 26px;
      color: #9ca3af;
    }

    .image-preview-box img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* TOAST (local, in case wala pa sa global css) */
    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: #2767ff;
      color: white;
      padding: 10px 18px;
      border-radius: 12px;
      opacity: 0;
      pointer-events: none;
      transition: 0.3s;
      z-index: 9999;
      font-size: 13px;
    }
    .toast.show {
      opacity: 1;
      pointer-events: all;
    }
  </style>
</head>

<body>
  <!-- SELLER NAVBAR -->
  <div class="navbar">
    <h1>BlueBite</h1>
    <div>
      <a href="seller-dashboard.html">Dashboard</a>
      <a href="seller-add-product.html">Add Product</a>
      <a href="seller-orders.html">Orders</a>
      <a href="#" onclick="Auth.logout()">Logout</a>
    </div>
  </div>

  <div class="page-wrapper">
    <div class="form-card">
      <h2>Add New Product üçΩÔ∏è</h2>
      <p class="subtext">
        Create a new item for your store's menu. Upload a photo so buyers can see what they‚Äôre ordering.
      </p>

      <form id="productForm">
        <div class="form-row">
          <label for="name">Product Name *</label>
          <input id="name" type="text" required placeholder="e.g. Cheesy Burger" />
        </div>

        <div class="form-row">
          <label for="price">Price (‚Ç±) *</label>
          <input id="price" type="number" step="0.01" min="0" required placeholder="e.g. 120" />
        </div>

        <div class="form-row">
          <label for="description">Description</label>
          <textarea id="description" placeholder="Short description of the product..."></textarea>
        </div>

        <div class="form-row">
          <label for="imageFile">Product Image</label>
          <input
            id="imageFile"
            type="file"
            accept="image/*"
          />
          <small>Optional, but recommended. This will upload to your Supabase Storage bucket <b>product-images</b>.</small>

          <div class="image-preview-wrap">
            <div class="image-preview-box" id="imagePreviewBox">üì∑</div>
            <small id="imagePreviewText">
              Choose a photo to see a preview here.
            </small>
          </div>
        </div>

        <div class="actions">
          <button type="button" class="btn-secondary" onclick="history.back()">
            Cancel
          </button>
          <button type="submit" id="saveBtn">
            Save Product
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="toast"></div>

  <!-- JS LOGIC -->
  <script type="module">
    import { supabase } from "./js/supabase.js";
    import { getSellerStore } from "./js/seller.js";
    import { requireAuth } from "./js/auth.js";
    import * as Auth from "./js/auth.js";

    window.Auth = Auth;

    let currentStore = null;

    function showToast(msg, color = "#2767ff") {
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.style.background = color;
      t.classList.add("show");
      setTimeout(() => t.classList.remove("show"), 1800);
    }

    async function initPage() {
      await requireAuth("seller", "seller-login.html");

      currentStore = await getSellerStore();
      if (!currentStore) {
        showToast("Please create your store first in Dashboard.", "#ef4444");
      }
    }

    initPage();

    const form = document.getElementById("productForm");
    const saveBtn = document.getElementById("saveBtn");
    const fileInput = document.getElementById("imageFile");
    const previewBox = document.getElementById("imagePreviewBox");
    const previewText = document.getElementById("imagePreviewText");

    // IMAGE PREVIEW
    fileInput.addEventListener("change", () => {
      const file = fileInput.files[0];
      if (!file) {
        previewBox.innerHTML = "üì∑";
        previewText.textContent = "Choose a photo to see a preview here.";
        return;
      }

      const reader = new FileReader();
      reader.onload = (e) => {
        previewBox.innerHTML = "";
        const img = document.createElement("img");
        img.src = e.target.result;
        previewBox.appendChild(img);
        previewText.textContent = file.name;
      };
      reader.readAsDataURL(file);
    });

    // HELPER: upload file to Supabase Storage
    async function uploadImageToSupabase(file, storeId) {
      if (!file) return null; // optional image

      const ext = file.name.split(".").pop();
      const safeName = file.name.replace(/\s+/g, "-").toLowerCase();
      const filePath = `store-${storeId}/${Date.now()}-${safeName}`;

      const { error: uploadError } = await supabase.storage
        .from("product-images")
        .upload(filePath, file);

      if (uploadError) {
        console.error(uploadError);
        throw new Error("Upload failed");
      }

      const { data: urlData } = supabase.storage
        .from("product-images")
        .getPublicUrl(filePath);

      return urlData.publicUrl;
    }

    // FORM SUBMIT
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      if (!currentStore) {
        showToast("No store found. Create store in dashboard first.", "#ef4444");
        return;
      }

      const name = document.getElementById("name").value.trim();
      const priceStr = document.getElementById("price").value.trim();
      const description = document.getElementById("description").value.trim();
      const file = fileInput.files[0];

      if (!name || !priceStr) {
        showToast("Please fill in required fields.", "#ef4444");
        return;
      }

      const price = Number(priceStr);
      if (isNaN(price) || price <= 0) {
        showToast("Please enter a valid price.", "#ef4444");
        return;
      }

      saveBtn.disabled = true;
      saveBtn.textContent = "Saving...";

      try {
        let imageUrl = null;

        // upload file if provided
        if (file) {
          imageUrl = await uploadImageToSupabase(file, currentStore.id);
        }

        const { error } = await supabase.from("products").insert([
          {
            store_id: currentStore.id,
            name,
            description,
            price,
            image_url: imageUrl,
          },
        ]);

        if (error) {
          console.error(error);
          showToast("Failed to save product.", "#ef4444");
          saveBtn.disabled = false;
          saveBtn.textContent = "Save Product";
          return;
        }

        showToast("Product added successfully!", "#22c55e");
        form.reset();
        previewBox.innerHTML = "üì∑";
        previewText.textContent = "Choose a photo to see a preview here.";
      } catch (err) {
        console.error(err);
        showToast("Image upload failed.", "#ef4444");
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = "Save Product";
      }
    });
  </script>
</body>
</html>